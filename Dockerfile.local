# syntax=docker/dockerfile:1.4
# Local Development Dockerfile
# This file is used for local development with hot reload support

# Stage 1: Install dependencies with Bun
FROM oven/bun:1.3.1-slim AS deps

WORKDIR /app

# Copy package files
COPY package.json bun.lock ./

# Install dependencies with Bun
RUN --mount=type=cache,target=/root/.bun/install/cache \
    bun install --frozen-lockfile

# Stage 2: Runtime with Node.js only
FROM node:22.20.0-slim

WORKDIR /app

# Install git and CA certificates for repository operations
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        git \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Install Claude Code CLI globally (required by @anthropic-ai/claude-agent-sdk)
RUN npm install -g @anthropic-ai/claude-code

# Create projects directory
RUN mkdir projects

# Copy dependencies from deps stage with proper ownership
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/package.json ./package.json
COPY --from=deps /app/bun.lock ./bun.lock

# Copy entrypoint script for installing kosuke-cli dependencies
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Development environment
ENV NODE_ENV=development
ENV HOSTNAME=0.0.0.0

EXPOSE 3000

# Use entrypoint to install kosuke-cli deps before starting
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

# Run development server with Node.js
# Source code will be mounted as volume for hot reload
CMD ["npm", "run", "dev"]

