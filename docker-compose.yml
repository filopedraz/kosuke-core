version: '3.8'

services:
  traefik:
    image: traefik:v3.0
    container_name: kosuke_traefik
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
      - '8080:8080'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - traefik_certs:/certs
    networks:
      - kosuke_network
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.traefik.rule=Host(`traefik.${MAIN_DOMAIN}`)'
      - 'traefik.http.routers.traefik.tls.certresolver=letsencrypt'
      - 'traefik.http.services.traefik.loadbalancer.server.port=8080'
    environment:
      - CLOUDFLARE_EMAIL=${CLOUDFLARE_EMAIL}
      - CLOUDFLARE_API_KEY=${CLOUDFLARE_API_KEY}
      - MAIN_DOMAIN=${MAIN_DOMAIN}
      - PREVIEW_BASE_DOMAIN=${PREVIEW_BASE_DOMAIN}

  postgres:
    image: postgres:16.4-alpine
    container_name: kosuke_postgres
    env_file:
      - .env
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - kosuke_network

  nextjs:
    image: ghcr.io/kosuke-org/kosuke-core:latest
    container_name: kosuke_nextjs
    env_file:
      - .env
    volumes:
      - ./projects:/app/projects:cached
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - kosuke_network
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.main.rule=Host(`${MAIN_DOMAIN}`) || Host(`www.${MAIN_DOMAIN}`)'
      - 'traefik.http.routers.main.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.main.middlewares=security-headers@file'
      - 'traefik.http.services.main.loadbalancer.server.port=3000'
      # Request wildcard certificate for preview domain
      - 'traefik.http.routers.wildcard-cert.rule=Host(`${PREVIEW_BASE_DOMAIN}`)'
      - 'traefik.http.routers.wildcard-cert.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.wildcard-cert.tls.domains[0].main=${PREVIEW_BASE_DOMAIN}'
      - 'traefik.http.routers.wildcard-cert.tls.domains[0].sans=*.${PREVIEW_BASE_DOMAIN}'
    depends_on:
      - postgres

  portainer:
    image: portainer/portainer-ce:latest
    container_name: kosuke_portainer
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - kosuke_network
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.portainer.rule=Host(`portainer.${MAIN_DOMAIN}`)'
      - 'traefik.http.routers.portainer.tls.certresolver=letsencrypt'
      - 'traefik.http.services.portainer.loadbalancer.server.port=9000'

volumes:
  postgres_data:
  traefik_certs:
  portainer_data:

networks:
  kosuke_network:
    name: kosuke_network
    driver: bridge
    attachable: true
